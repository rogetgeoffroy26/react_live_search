!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t=t||self).Searchbase=e()}(this,(function(){"use strict";function t(t,e){for(var s=0;s<e.length;s++){var i=e[s];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function e(e,s,i){return s&&t(e.prototype,s),i&&t(e,i),e}function s(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}function i(){return(i=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var s=arguments[e];for(var i in s)Object.prototype.hasOwnProperty.call(s,i)&&(t[i]=s[i])}return t}).apply(this,arguments)}var r="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};var n=function(t,e){return t(e={exports:{}},e.exports),e.exports}((function(t,e){var s=function(t){function e(){this.fetch=!1,this.DOMException=t.DOMException}return e.prototype=t,new e}("undefined"!=typeof self?self:r);!function(t){!function(e){var s="URLSearchParams"in t,i="Symbol"in t&&"iterator"in Symbol,r="FileReader"in t&&"Blob"in t&&function(){try{return new Blob,!0}catch(t){return!1}}(),n="FormData"in t,o="ArrayBuffer"in t;if(o)var a=["[object Int8Array]","[object Uint8Array]","[object Uint8ClampedArray]","[object Int16Array]","[object Uint16Array]","[object Int32Array]","[object Uint32Array]","[object Float32Array]","[object Float64Array]"],u=ArrayBuffer.isView||function(t){return t&&a.indexOf(Object.prototype.toString.call(t))>-1};function h(t){if("string"!=typeof t&&(t=String(t)),/[^a-z0-9\-#$%&'*+.^_`|~]/i.test(t))throw new TypeError("Invalid character in header field name");return t.toLowerCase()}function c(t){return"string"!=typeof t&&(t=String(t)),t}function d(t){var e={next:function(){var e=t.shift();return{done:void 0===e,value:e}}};return i&&(e[Symbol.iterator]=function(){return e}),e}function l(t){this.map={},t instanceof l?t.forEach((function(t,e){this.append(e,t)}),this):Array.isArray(t)?t.forEach((function(t){this.append(t[0],t[1])}),this):t&&Object.getOwnPropertyNames(t).forEach((function(e){this.append(e,t[e])}),this)}function g(t){if(t.bodyUsed)return Promise.reject(new TypeError("Already read"));t.bodyUsed=!0}function f(t){return new Promise((function(e,s){t.onload=function(){e(t.result)},t.onerror=function(){s(t.error)}}))}function p(t){var e=new FileReader,s=f(e);return e.readAsArrayBuffer(t),s}function y(t){if(t.slice)return t.slice(0);var e=new Uint8Array(t.byteLength);return e.set(new Uint8Array(t)),e.buffer}function v(){return this.bodyUsed=!1,this._initBody=function(t){var e;this._bodyInit=t,t?"string"==typeof t?this._bodyText=t:r&&Blob.prototype.isPrototypeOf(t)?this._bodyBlob=t:n&&FormData.prototype.isPrototypeOf(t)?this._bodyFormData=t:s&&URLSearchParams.prototype.isPrototypeOf(t)?this._bodyText=t.toString():o&&r&&((e=t)&&DataView.prototype.isPrototypeOf(e))?(this._bodyArrayBuffer=y(t.buffer),this._bodyInit=new Blob([this._bodyArrayBuffer])):o&&(ArrayBuffer.prototype.isPrototypeOf(t)||u(t))?this._bodyArrayBuffer=y(t):this._bodyText=t=Object.prototype.toString.call(t):this._bodyText="",this.headers.get("content-type")||("string"==typeof t?this.headers.set("content-type","text/plain;charset=UTF-8"):this._bodyBlob&&this._bodyBlob.type?this.headers.set("content-type",this._bodyBlob.type):s&&URLSearchParams.prototype.isPrototypeOf(t)&&this.headers.set("content-type","application/x-www-form-urlencoded;charset=UTF-8"))},r&&(this.blob=function(){var t=g(this);if(t)return t;if(this._bodyBlob)return Promise.resolve(this._bodyBlob);if(this._bodyArrayBuffer)return Promise.resolve(new Blob([this._bodyArrayBuffer]));if(this._bodyFormData)throw new Error("could not read FormData body as blob");return Promise.resolve(new Blob([this._bodyText]))},this.arrayBuffer=function(){return this._bodyArrayBuffer?g(this)||Promise.resolve(this._bodyArrayBuffer):this.blob().then(p)}),this.text=function(){var t,e,s,i=g(this);if(i)return i;if(this._bodyBlob)return t=this._bodyBlob,e=new FileReader,s=f(e),e.readAsText(t),s;if(this._bodyArrayBuffer)return Promise.resolve(function(t){for(var e=new Uint8Array(t),s=new Array(e.length),i=0;i<e.length;i++)s[i]=String.fromCharCode(e[i]);return s.join("")}(this._bodyArrayBuffer));if(this._bodyFormData)throw new Error("could not read FormData body as text");return Promise.resolve(this._bodyText)},n&&(this.formData=function(){return this.text().then(b)}),this.json=function(){return this.text().then(JSON.parse)},this}l.prototype.append=function(t,e){t=h(t),e=c(e);var s=this.map[t];this.map[t]=s?s+", "+e:e},l.prototype.delete=function(t){delete this.map[h(t)]},l.prototype.get=function(t){return t=h(t),this.has(t)?this.map[t]:null},l.prototype.has=function(t){return this.map.hasOwnProperty(h(t))},l.prototype.set=function(t,e){this.map[h(t)]=c(e)},l.prototype.forEach=function(t,e){for(var s in this.map)this.map.hasOwnProperty(s)&&t.call(e,this.map[s],s,this)},l.prototype.keys=function(){var t=[];return this.forEach((function(e,s){t.push(s)})),d(t)},l.prototype.values=function(){var t=[];return this.forEach((function(e){t.push(e)})),d(t)},l.prototype.entries=function(){var t=[];return this.forEach((function(e,s){t.push([s,e])})),d(t)},i&&(l.prototype[Symbol.iterator]=l.prototype.entries);var _=["DELETE","GET","HEAD","OPTIONS","POST","PUT"];function m(t,e){var s,i,r=(e=e||{}).body;if(t instanceof m){if(t.bodyUsed)throw new TypeError("Already read");this.url=t.url,this.credentials=t.credentials,e.headers||(this.headers=new l(t.headers)),this.method=t.method,this.mode=t.mode,this.signal=t.signal,r||null==t._bodyInit||(r=t._bodyInit,t.bodyUsed=!0)}else this.url=String(t);if(this.credentials=e.credentials||this.credentials||"same-origin",!e.headers&&this.headers||(this.headers=new l(e.headers)),this.method=(s=e.method||this.method||"GET",i=s.toUpperCase(),_.indexOf(i)>-1?i:s),this.mode=e.mode||this.mode||null,this.signal=e.signal||this.signal,this.referrer=null,("GET"===this.method||"HEAD"===this.method)&&r)throw new TypeError("Body not allowed for GET or HEAD requests");this._initBody(r)}function b(t){var e=new FormData;return t.trim().split("&").forEach((function(t){if(t){var s=t.split("="),i=s.shift().replace(/\+/g," "),r=s.join("=").replace(/\+/g," ");e.append(decodeURIComponent(i),decodeURIComponent(r))}})),e}function w(t,e){e||(e={}),this.type="default",this.status=void 0===e.status?200:e.status,this.ok=this.status>=200&&this.status<300,this.statusText="statusText"in e?e.statusText:"OK",this.headers=new l(e.headers),this.url=e.url||"",this._initBody(t)}m.prototype.clone=function(){return new m(this,{body:this._bodyInit})},v.call(m.prototype),v.call(w.prototype),w.prototype.clone=function(){return new w(this._bodyInit,{status:this.status,statusText:this.statusText,headers:new l(this.headers),url:this.url})},w.error=function(){var t=new w(null,{status:0,statusText:""});return t.type="error",t};var S=[301,302,303,307,308];w.redirect=function(t,e){if(-1===S.indexOf(e))throw new RangeError("Invalid status code");return new w(null,{status:e,headers:{location:t}})},e.DOMException=t.DOMException;try{new e.DOMException}catch(t){e.DOMException=function(t,e){this.message=t,this.name=e;var s=Error(t);this.stack=s.stack},e.DOMException.prototype=Object.create(Error.prototype),e.DOMException.prototype.constructor=e.DOMException}function q(t,s){return new Promise((function(i,n){var o=new m(t,s);if(o.signal&&o.signal.aborted)return n(new e.DOMException("Aborted","AbortError"));var a=new XMLHttpRequest;function u(){a.abort()}a.onload=function(){var t,e,s={status:a.status,statusText:a.statusText,headers:(t=a.getAllResponseHeaders()||"",e=new l,t.replace(/\r?\n[\t ]+/g," ").split(/\r?\n/).forEach((function(t){var s=t.split(":"),i=s.shift().trim();if(i){var r=s.join(":").trim();e.append(i,r)}})),e)};s.url="responseURL"in a?a.responseURL:s.headers.get("X-Request-URL");var r="response"in a?a.response:a.responseText;i(new w(r,s))},a.onerror=function(){n(new TypeError("Network request failed"))},a.ontimeout=function(){n(new TypeError("Network request failed"))},a.onabort=function(){n(new e.DOMException("Aborted","AbortError"))},a.open(o.method,o.url,!0),"include"===o.credentials?a.withCredentials=!0:"omit"===o.credentials&&(a.withCredentials=!1),"responseType"in a&&r&&(a.responseType="blob"),o.headers.forEach((function(t,e){a.setRequestHeader(e,t)})),o.signal&&(o.signal.addEventListener("abort",u),a.onreadystatechange=function(){4===a.readyState&&o.signal.removeEventListener("abort",u)}),a.send(void 0===o._bodyInit?null:o._bodyInit)}))}q.polyfill=!0,t.fetch||(t.fetch=q,t.Headers=l,t.Request=m,t.Response=w),e.Headers=l,e.Request=m,e.Response=w,e.fetch=q}({})}(s),delete s.fetch.polyfill,(e=s.fetch).default=s.fetch,e.fetch=s.fetch,e.Headers=s.Headers,e.Request=s.Request,e.Response=s.Response,t.exports=e}));n.fetch,n.Headers,n.Request,n.Response;function o(){return(o=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var s=arguments[e];for(var i in s)Object.prototype.hasOwnProperty.call(s,i)&&(t[i]=s[i])}return t}).apply(this,arguments)}function a(t){void 0===t&&(t="");for(var e,s=t,i="",r=0,n=0,o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";s.charAt(0|n)||(o="=",n%1);i+=o.charAt(63&r>>8-n%1*8)){if((e=s.charCodeAt(n+=.75))>255)throw new Error('"btoa" failed: The string to be encoded contains characters outside of the Latin1 range.');r=r<<8|e}return i}function u(t,e){if(null==t&&!e)throw new Error("appbase-analytics: query or queryID must be present to register a click/conversion event")}var h={init:function(t){void 0===t&&(t={});var e={credentials:t.credentials,index:t.index,url:t.url,userID:t.userID,globalEventData:t.globalEventData,queryID:"",headers:null};return function(t){if(!t)throw new Error("appbase-analytics: A valid index must be present to record analytics events.")}(e.index),function(t){if(!t)throw new Error("appbase-analytics: Auth credentials is missing.")}(e.credentials),function(t){if(!t)throw new Error("appbase-analytics: URL is missing.")}(e.url),e._request=function(t,s,i){var r=o({},s,{user_id:e.userID,event_data:o({},s&&s.event_data,{},e.globalEventData)});return n(e.url+"/"+e.index+"/_analytics/"+t,{method:"PUT",headers:o({},e.headers,{"Content-Type":"application/json",Authorization:"Basic "+a(e.credentials)}),body:JSON.stringify(r)}).then((function(t){i&&i(null,t)})).catch((function(t){console.error(t),i&&i(t,null)}))},e.search=function(t,s){u(t.query,t.queryID);if(e._request){var i={query:t.query,query_id:t.queryID,event_data:t.eventData,filters:t.filters,hits:t.hits};e._request("search",i,(function(t,i){i&&i.json().then((function(t){t&&t.query_id&&(e.queryID=t.query_id)})).catch((function(t){console.error(t)})),s&&s(t,i)}))}},e.click=function(t,s){if(u(t.query,t.queryID),function(t){if(!t||Object.keys(t).length<1)throw new Error("appbase-analytics: at least one click object must be present to register a click event")}(t.objects),e._request){var i={click_on:t.objects,click_type:t.isSuggestionClick?"suggestion":"result",query:t.query,query_id:t.queryID,event_data:t.eventData};e._request("click",i,s)}},e.conversion=function(t,s){if(u(t.query,t.queryID),function(t){if(!t||Object.keys(t).length<1)throw new Error("appbase-analytics: at least one click object must be present to register a click event")}(t.objects),e._request){var i={conversion_on:t.objects,query:t.query,query_id:t.queryID,event_data:t.eventData};e._request("conversion",i,s)}},e.setUserID=function(t){e.userID=t},e.setGlobalEventData=function(t){e.globalEventData=t},e.setHeaders=function(t){e.headers=t},e}},c=function(t){var e=[];return t&&(e=[].concat(t).map((function(t){var e={};t._updated?e._updated=t._updated:t._deleted&&(e._deleted=t._deleted);var s=function(t){var e=i({},t);return e.highlight&&Object.keys(e.highlight).forEach((function(t){var s,r=e.highlight[t][0];e._source=i({},e._source,((s={})[t]=r,s))})),e}(t);return Object.keys(s).filter((function(t){return"_source"!==t})).reduce((function(t,e){return t[e]=s[e],t}),i({},s._source,{},e))}))),e},d=function(t){return"object"==typeof t?Array.isArray(t)?function t(e){return e.reduce((function(e,s){return e.concat(Array.isArray(s)?t(s):s)}),[])}(t):null:t},l=function(t,e,s){void 0===t&&(t=[]),void 0===s&&(s="");var r=[],n=[],o=function(t,e,i){if(s.trim().split(" ").some((function(e){return String(t).toLowerCase().includes(e)}))&&!n.includes(t)||i._promoted){var o={label:t,value:t,source:i};n=[].concat(n,[t]),r=[].concat(r,[o])}};return e.forEach((function(e){var s=e._score,r=e._index,n=e._type,a=i({},e,{_id:e._id,_index:r,_score:s,_type:n});t.forEach((function(t){!function t(e,s,i){if(void 0===s&&(s=""),void 0===i&&(i=e),"object"==typeof e){var r=s.split("."),n=e[r[0]];if(n)if(r.length>1){var a=s.substring(r[0].length+1);Array.isArray(n)?n.forEach((function(e){t(e,a,i)})):t(n,a,i)}else{var u=d(n);u&&(Array.isArray(u)?u.forEach((function(t){return o(t,0,i)})):o(u,0,i))}}}(a,t)}))})),r};var g=function(){function t(t){var e=this;s(this,"data",void 0),s(this,"raw",void 0),s(this,"parseResults",void 0),s(this,"setRaw",(function(t){e.raw=t,t.hits&&t.hits.hits&&e.setData(t.hits.hits)})),this.data=t||[]}return t.prototype.setData=function(t){var e=c(t);if(this.promotedData.length){var s=this.promotedData.map((function(t){return t._id})).filter(Boolean);s&&(e=e.filter((function(t){return!s.includes(t._id)}))),e=[].concat(this.promotedData.map((function(t){return i({},t,{_promoted:!0})})),e)}this.parseResults?this.data=this.parseResults(e,t):this.data=e},e(t,[{key:"numberOfResults",get:function(){return this.raw&&this.raw.hits?"object"==typeof this.raw.hits.total?this.raw.hits.total.value:this.raw.hits.total:0}},{key:"time",get:function(){return this.raw?this.raw.took:0}},{key:"hidden",get:function(){return this.raw&&this.raw.hits&&this.raw.hits.hidden||0}},{key:"promoted",get:function(){return this.raw&&this.raw.promoted?this.raw.promoted.length:0}},{key:"promotedData",get:function(){return this.raw&&this.raw.promoted&&this.raw.promoted||[]}},{key:"rawData",get:function(){return this.raw||{}}},{key:"customData",get:function(){return this.raw&&this.raw.customData&&this.raw.customData||{}}}]),t}(),f=function(){function t(){s(this,"observers",void 0),this.observers=[]}var e=t.prototype;return e.subscribe=function(t,e){this.observers.push({callback:t,properties:e})},e.unsubscribe=function(t){this.observers=t?this.observers.filter((function(e){return e.callback!==t?e:null})):[]},e.next=function(t,e,s){var i=s||window;this.observers.forEach((function(s){void 0===s.properties?s.callback.call(i,t):s.properties instanceof Array&&s.properties.length&&s.properties.includes(e)?s.callback.call(i,t):"string"==typeof s.properties&&s.properties&&s.properties===e&&s.callback.call(i,t)}))},t}(),p=function(){function t(t){s(this,"data",void 0),s(this,"afterKey",void 0),s(this,"raw",void 0),this.data=t||[]}var r=t.prototype;return r.setRaw=function(t){this.raw=t,t.after_key&&this.setAfterKey(t.after_key)},r.setAfterKey=function(t){this.afterKey=t},r.setData=function(t,e){var s,r;this.data=(s=t,void 0===(r=e)&&(r=[]),r.map((function(t){var e=t.doc_count,r=t.key,n=t[s];return i({_doc_count:e,_key:r[s]},n.hits.hits[0])})))},e(t,[{key:"rawData",get:function(){return this.raw||{}}}]),t}(),y="INACTIVE",v="ACTIVE",_="DENIED",m="INACTIVE",b="PENDING",w="ERROR",S={triggerQuery:!0,triggerSuggestionsQuery:!1,stateChanges:!0},q={stateChanges:!0},F=function(){function t(t){var e=this,r=t.index,n=t.url,o=t.enableAppbase,a=t.enableQuerySuggestions,u=t.credentials,c=t.appbaseConfig,d=t.headers,b=t.value,w=t.suggestions,q=t.querySuggestions,F=t.results,R=t.fuzziness,O=t.searchOperators,A=t.queryFormat,E=t.size,D=t.from,Q=t.dataField,C=t.aggregationField,x=t.includeFields,I=t.excludeFields,k=t.transformQuery,B=t.transformSuggestionsQuery,z=t.transformRequest,j=t.transformResponse,P=t.beforeValueChange,T=t.sortBy,U=t.nestedField,M=t.sortOptions,V=t.sortByField,L=t.highlight,N=t.highlightField;if(s(this,"index",void 0),s(this,"url",void 0),s(this,"enableAppbase",void 0),s(this,"enableQuerySuggestions",void 0),s(this,"credentials",void 0),s(this,"appbaseConfig",void 0),s(this,"value",void 0),s(this,"headers",void 0),s(this,"suggestions",void 0),s(this,"querySuggestions",void 0),s(this,"aggregationData",void 0),s(this,"suggestionsError",void 0),s(this,"results",void 0),s(this,"error",void 0),s(this,"stateChanges",void 0),s(this,"requestStatus",void 0),s(this,"suggestionsRequestStatus",void 0),s(this,"nestedField",void 0),s(this,"queryFormat",void 0),s(this,"searchOperators",void 0),s(this,"size",void 0),s(this,"from",void 0),s(this,"fuzziness",void 0),s(this,"sortBy",void 0),s(this,"sortByField",void 0),s(this,"dataField",void 0),s(this,"aggregationField",void 0),s(this,"includeFields",void 0),s(this,"excludeFields",void 0),s(this,"sortOptions",void 0),s(this,"highlight",void 0),s(this,"highlightField",void 0),s(this,"onValueChange",void 0),s(this,"onResults",void 0),s(this,"onSuggestions",void 0),s(this,"onQuerySuggestions",void 0),s(this,"onAggregationData",void 0),s(this,"onError",void 0),s(this,"onSuggestionsError",void 0),s(this,"onRequestStatusChange",void 0),s(this,"onSuggestionsRequestStatusChange",void 0),s(this,"onQueryChange",void 0),s(this,"onSuggestionsQueryChange",void 0),s(this,"onMicStatusChange",void 0),s(this,"transformQuery",void 0),s(this,"transformSuggestionsQuery",void 0),s(this,"transformRequest",void 0),s(this,"transformResponse",void 0),s(this,"beforeValueChange",void 0),s(this,"_query",void 0),s(this,"_suggestionsQuery",void 0),s(this,"_queryOptions",void 0),s(this,"_micStatus",void 0),s(this,"_micInstance",void 0),s(this,"_analyticsInstance",void 0),s(this,"_queryId",void 0),s(this,"onMicClick",(function(t,s){void 0===t&&(t={}),void 0===s&&(s=S);var i=e._micStatus;if("undefined"!=typeof window&&(window.SpeechRecognition=window.webkitSpeechRecognition||window.SpeechRecognition||null),window&&window.SpeechRecognition&&i!==_){i===v&&e._setMicStatus(y,s);var r=window.SpeechRecognition;if(e._micInstance)return void e._stopMic();e._micInstance=new r,e._micInstance.continuous=!0,e._micInstance.interimResults=!0,Object.assign(e._micInstance,t),e._micInstance.start(),e._micInstance.onstart=function(){e._setMicStatus(v,s)},e._micInstance.onresult=function(t){var i=t.results;i&&i[0]&&i[0].isFinal&&e._stopMic(),e._handleVoiceResults({results:i},s)},e._micInstance.onerror=function(t){"no-speech"===t.error||"audio-capture"===t.error?e._setMicStatus(y,s):"not-allowed"===t.error&&e._setMicStatus(_,s),console.error(t)}}})),s(this,"recordClick",(function(t,s){void 0===s&&(s=!1),e._analyticsInstance&&e._queryId&&e._analyticsInstance.click({queryID:e._queryId,objects:t,isSuggestionClick:s})})),s(this,"recordConversions",(function(t){e._analyticsInstance&&e._queryId&&e._analyticsInstance.conversion({queryID:e._queryId,objects:t})})),s(this,"_handleVoiceResults",(function(t,s){var i=t.results;void 0===s&&(s=S),i&&i[0]&&i[0].isFinal&&i[0][0]&&i[0][0].transcript&&i[0][0].transcript.trim()&&e.setValue(i[0][0].transcript.trim(),s)})),s(this,"_stopMic",(function(){e._micInstance&&(e._micInstance.stop(),e._micInstance=null,e._setMicStatus(y))})),s(this,"_setMicStatus",(function(t,s){void 0===s&&(s=S);var i=e._micStatus;e._micStatus=t,e._applyOptions(s,"micStatus",i,e._micStatus)})),s(this,"_parseSuggestions",(function(t,s){var i=e.getDataFields();return 0===i.length&&s&&Array.isArray(s)&&s.length>0&&s[0]&&s[0]._source&&(i=Object.keys(s[0]._source)),l(i,t,e.value).slice(0,e.size)})),s(this,"_parseQuerySuggestions",(function(t){return l(["key","key.autosuggest","key.search"],t,e.value)})),!r)throw new Error("Please provide a valid index.");if(!n)throw new Error("Please provide a valid url.");if(!o&&!Q)throw new Error("Please provide a valid data field.");this.index=r,this.url=n,this.enableAppbase=o||!1,this.enableQuerySuggestions=a||!1,this.appbaseConfig=c,this._analyticsInstance=h.init({index:r,url:n,credentials:u}),this.dataField=Q,this.aggregationField=C,this.credentials=u||"",this.nestedField=U,this.queryFormat=A||"or",this.fuzziness=R||0,this.searchOperators=O||!1,this.size=Number(E)||10,this.from=Number(D)||0,this.sortBy=T,this.includeFields=x||["*"],this.excludeFields=I||[],this.sortOptions=M||null,this.sortByField=V,this.highlight=L,this.highlightField=N,this.requestStatus=m,this.suggestionsRequestStatus=m,this.transformRequest=z||null,this.transformResponse=j||null,this.transformQuery=k||null,this.transformSuggestionsQuery=B||null,this.beforeValueChange=P||null,this.stateChanges=new f,this.suggestions=new g(w),this.suggestions.parseResults=this._parseSuggestions,this.querySuggestions=new g(q),this.querySuggestions.parseResults=this._parseQuerySuggestions,this.results=new g(F),this.aggregationData=new p,this.headers={Accept:"application/json","Content-Type":"application/json"},this.credentials&&(this.headers=i({},this.headers,{Authorization:"Basic "+btoa(this.credentials)})),d&&this.setHeaders(d,{stateChanges:!1}),b?this.setValue(b,{stateChanges:!0}):this.value=""}var r=t.prototype;return r.subscribeToStateChanges=function(t,e){this.stateChanges.subscribe(t,e)},r.unsubscribeToStateChanges=function(t){this.stateChanges.unsubscribe(t)},r.setHeaders=function(t,e){void 0===e&&(e=S);var s=this.headers;this.headers=i({},this.headers,{},t),this._applyOptions(e,"headers",s,this.headers)},r.setSize=function(t,e){void 0===e&&(e=S);var s=this.size;this.size=t,this._applyOptions(e,"size",s,this.size)},r.setFrom=function(t,e){void 0===e&&(e=S);var s=this.from;this.from=t,this._applyOptions(e,"from",s,this.from)},r.setFuzziness=function(t,e){void 0===e&&(e=S);var s=this.fuzziness;this.fuzziness=t,this._applyOptions(e,"fuzziness",s,this.fuzziness)},r.setIncludeFields=function(t,e){void 0===e&&(e=S);var s=this.includeFields;this.includeFields=t,this._applyOptions(e,"includeFields",s,t)},r.setExcludeFields=function(t,e){void 0===e&&(e=S);var s=this.excludeFields;this.excludeFields=t,this._applyOptions(e,"excludeFields",s,t)},r.setSortBy=function(t,e){void 0===e&&(e=S);var s=this.sortBy;this.sortBy=t,this._applyOptions(e,"sortBy",s,t)},r.setSortByField=function(t,e){void 0===e&&(e=S);var s=this.sortByField;this.sortByField=t,this._applyOptions(e,"sortByField",s,t)},r.setNestedField=function(t,e){void 0===e&&(e=S);var s=this.nestedField;this.nestedField=t,this._applyOptions(e,"nestedField",s,t)},r.setDataField=function(t,e){void 0===e&&(e=S);var s=this.dataField;this.dataField=t,this._applyOptions(e,"dataField",s,t)},r.setResults=function(t,e){if(void 0===e&&(e=q),t){var s=this.results;this.results=new g(t),this._applyOptions({stateChanges:e.stateChanges},"results",s,this.results)}},r.setSuggestions=function(t,e){if(void 0===e&&(e=q),t){var s=this.suggestions;this.suggestions=new g(t),this.suggestions.parseResults=this._parseSuggestions,this._applyOptions({stateChanges:e.stateChanges},"suggestions",s,this.suggestions)}},r.setValue=function(t,e){var s=this;void 0===e&&(e=S);var i=function(){var i=s.value;s.value=t,s._applyOptions(e,"value",i,s.value)};this.beforeValueChange?this.beforeValueChange(t).then(i).catch((function(t){console.warn("beforeValueChange rejected the promise with ",t)})):i()},r.triggerQuery=function(t){var e=this;void 0===t&&(t=q);var s=function(s){return e._setError(s,{stateChanges:t.stateChanges}),console.error(s),Promise.reject(s)};try{return this._updateQuery(),this._setRequestStatus(b),(this.transformQuery?this.transformQuery(this.query):new Promise((function(t){return t(e.query)}))).then((function(i){e._fetchRequest(i).then((function(s){e._setRequestStatus(m);var i=e.results,r=s;return e.enableAppbase&&(r=s.SearchResult),e.results.setRaw(r),e._applyOptions({stateChanges:t.stateChanges},"results",i,e.results),Promise.resolve(r)})).catch(s)})).catch(s)}catch(t){return s(t)}},r.triggerSuggestionsQuery=function(t){var e=this;void 0===t&&(t=q);var s=function(s){return e._setSuggestionsError(s,{stateChanges:t.stateChanges}),console.error(s),Promise.reject(s)};try{return this._updateSuggestionsQuery(),this._setSuggestionsRequestStatus(b),(this.transformSuggestionsQuery?this.transformSuggestionsQuery(this.suggestionsQuery):new Promise((function(t){return t(e.suggestionsQuery)}))).then((function(i){e._fetchRequest(i).then((function(i){var r=i;e.enableAppbase&&(r=i.DataSearch),e.enableAppbase&&e.enableQuerySuggestions?e._fetchRequest(e.getSuggestionsQuery(),!0).then((function(s){e._setSuggestionsRequestStatus(m),e._handleQuerySuggestionsResponse(s,t)})).catch(s):e._setSuggestionsRequestStatus(m),r.aggregations&&e._handleCompositeAggsResponse(e.aggregationField,r.aggregations,t);var n=e.suggestions;return e.suggestions.setRaw(r),e._applyOptions({stateChanges:t.stateChanges},"suggestions",n,e.suggestions),Promise.resolve(r)})).catch(s)})).catch(s)}catch(t){return s(t)}},r.getSuggestionsQuery=function(){return{query:[{id:"DataSearch__suggestions",dataField:["key","key.autosuggest","key.search"],searchOperators:this.searchOperators,size:5,value:this.value,defaultQuery:{sort:[{count:{order:"desc"}}]}}]}},r._handleCompositeAggsResponse=function(t,e,s){void 0===s&&(s=S);var i=this.aggregationData;this.aggregationData.setRaw(e[t]),this.aggregationData.setData(t,e[t].buckets),this._applyOptions({stateChanges:s.stateChanges},"aggregations",i,this.aggregationData)},r._handleTransformResponse=function(t){return this.transformResponse&&"function"==typeof this.transformResponse?this.transformResponse(t):new Promise((function(e){return e(t)}))},r._handleTransformRequest=function(t){return this.transformRequest&&"function"==typeof this.transformRequest?this.transformRequest(t):new Promise((function(e){return e(t)}))},r._handleQuerySuggestionsResponse=function(t,e){var s=this.querySuggestions,i=t&&t.DataSearch__suggestions;this.querySuggestions.setRaw(i),this._applyOptions({stateChanges:e.stateChanges},"querySuggestions",s,this.querySuggestions)},r._fetchRequest=function(t,e){var s=this;void 0===e&&(e=!1);var r={method:"POST",body:JSON.stringify(t),headers:i({},this.headers)};return new Promise((function(t,o){s._handleTransformRequest(r).then((function(r){var a=Date.now(),u="_search";s.enableAppbase&&(u="_reactivesearch.v3");var h=e?".suggestions":s.index;return n(s.url+"/"+h+"/"+u,r).then((function(e){var r=e.headers;return e.headers&&(s._queryId=e.headers.get("X-Search-Id")||null),e.status>=500?o(e):e.status>=400?o(e):e.json().then((function(e){s._handleTransformResponse(e).then((function(e){e&&Object.prototype.hasOwnProperty.call(e,"error")&&o(e);var s=i({},e,{_timestamp:a,_headers:r});return t(s)})).catch((function(t){return console.warn("transformResponse rejected the promise with ",t),o(t)}))}))})).catch((function(t){return o(t)}))})).catch((function(t){return console.warn("transformRequest rejected the promise with ",t),o(t)}))}))},r._setSuggestionsError=function(t,e){void 0===e&&(e=S),this._setSuggestionsRequestStatus(w);var s=this.suggestionsError;this.suggestionsError=t,this._applyOptions(e,"suggestionsError",s,this.suggestionsError)},r._setError=function(t,e){void 0===e&&(e=S),this._setRequestStatus(w);var s=this.error;this.error=t,this._applyOptions(e,"error",s,this.error)},r._setRequestStatus=function(t){var e=this.requestStatus;this.requestStatus=t,this._applyOptions({stateChanges:!0},"requestStatus",e,this.requestStatus)},r._setSuggestionsRequestStatus=function(t){var e=this.suggestionsRequestStatus;this.suggestionsRequestStatus=t,this._applyOptions({stateChanges:!0},"suggestionsRequestStatus",e,this.suggestionsRequestStatus)},r._updateQuery=function(t,e){var s;this.enableAppbase?(s=i({},this._query),this._query={query:[i({},this.getAppbaseSuggestionsQuery(),{execute:!1}),this.getAppbaseResultQuery()],settings:this.getAppbaseSettings()}):s=this.getPreviousQuery(t,e),this._applyOptions({stateChanges:!1},"query",s,this._query)},r.getAppbaseSettings=function(){var t=this.appbaseConfig;return{recordAnalytics:t.recordAnalytics,customEvents:t.customEvents,enableQueryRules:t.enableQueryRules,userId:t.userId}},r.getAppbaseResultQuery=function(){return{id:"SearchResult",dataField:this.getDataFields(),from:this.from,size:this.size,sortBy:this.sortBy,includeFields:this.includeFields,excludeFields:this.excludeFields,react:{and:"DataSearch"}}},r.getPreviousQuery=function(e,s){var r=t.generateQueryOptions({excludeFields:this.excludeFields,includeFields:this.includeFields,size:this.size,from:this.from,sortBy:this.sortBy,sortByField:this.sortByField,sortOptions:this.sortOptions}),n=e||t.defaultQuery(this.value,{dataField:this.dataField,searchOperators:this.searchOperators,queryFormat:this.queryFormat,fuzziness:this.fuzziness,nestedField:this.nestedField})||{match_all:{}},o=this._query;return this._query=i({query:n},t.highlightQuery(this.highlight,this.highlightField,this.dataField),{},r,{},s),o},r._updateSuggestionsQuery=function(t,e){var s;this.enableAppbase?(s=i({},this._suggestionsQuery),this._suggestionsQuery={query:[this.getAppbaseSuggestionsQuery()],settings:this.getAppbaseSettings()}):s=this.getPreviousSuggestionsQuery(t,e),this._applyOptions({stateChanges:!1},"suggestionsQuery",s,this._suggestionsQuery)},r.getAppbaseSuggestionsQuery=function(){return{id:"DataSearch",dataField:this.getDataFields(),value:this.value,queryFormat:this.queryFormat,nestedField:this.nestedField,from:this.from,size:this.size,sortBy:this.sortBy,aggregationField:this.aggregationField,includeFields:this.includeFields,excludeFields:this.excludeFields,fuzziness:this.fuzziness,searchOperators:this.searchOperators,highlight:this.highlight,highlightField:this.highlightField}},r.getPreviousSuggestionsQuery=function(e,s){var r=t.generateQueryOptions({aggregationField:this.aggregationField,size:this.size}),n=e||t.defaultQuery(this.value,{dataField:this.dataField,searchOperators:this.searchOperators,queryFormat:this.queryFormat,fuzziness:this.fuzziness,nestedField:this.nestedField})||{match_all:{}},o=i({},this._suggestionsQuery);return this._suggestionsQuery=i({query:n},t.highlightQuery(this.highlight,this.highlightField,this.dataField),{},r,{},s),o},r.getDataFields=function(){var t=[];return"string"===this.dataField?t=[this.dataField]:Array.isArray(this.dataField)&&this.dataField.forEach((function(e){"object"==typeof e?t.push(e.field):t.push(e)})),t},r._applyOptions=function(t,e,s,i){var r;("micStatus"===e&&this.onMicStatusChange&&this.onMicStatusChange(i,s),"query"===e&&this.onQueryChange&&this.onQueryChange(i,s),"suggestionsQuery"===e&&this.onSuggestionsQueryChange&&this.onSuggestionsQueryChange(i,s),"value"===e&&this.onValueChange&&this.onValueChange(i,s),"error"===e&&this.onError&&this.onError(i),"suggestionsError"===e&&this.onSuggestionsError&&this.onSuggestionsError(i),"results"===e&&this.onResults&&this.onResults(i,s),"suggestions"===e&&this.onSuggestions&&this.onSuggestions(i,s),"querySuggestions"===e&&this.onQuerySuggestions&&this.onQuerySuggestions(i,s),"aggregations"===e&&this.onAggregationData&&this.onAggregationData(i,s),"requestStatus"===e&&this.onRequestStatusChange&&this.onRequestStatusChange(i,s),"suggestionsRequestStatus"===e&&this.onSuggestionsRequestStatusChange&&this.onSuggestionsRequestStatusChange(i,s),t.triggerQuery&&this.triggerQuery(),t.triggerSuggestionsQuery&&this.triggerSuggestionsQuery(),!1!==t.stateChanges)&&this.stateChanges.next(((r={})[e]={prev:s,next:i},r),e)},e(t,[{key:"micStatus",get:function(){return this._micStatus}},{key:"micInstance",get:function(){return this._micInstance}},{key:"micActive",get:function(){return this._micStatus===v}},{key:"micInactive",get:function(){return this._micStatus===y}},{key:"micDenied",get:function(){return this._micStatus===_}},{key:"query",get:function(){return this._query}},{key:"suggestionsQuery",get:function(){return this._suggestionsQuery}},{key:"requestPending",get:function(){return this.requestStatus===b}},{key:"suggestionsRequestPending",get:function(){return this.suggestionsRequestStatus===b}}]),t}();return s(F,"defaultQuery",void 0),s(F,"shouldQuery",void 0),s(F,"highlightQuery",void 0),s(F,"compositeAggsQuery",void 0),s(F,"generateQueryOptions",void 0),F.defaultQuery=function(t,e){var s,i=null;return t&&(s=Array.isArray(e.dataField)?e.dataField:[e.dataField],i=e.searchOperators?{simple_query_string:F.shouldQuery(t,s,e)}:{bool:{should:F.shouldQuery(t,s,e),minimum_should_match:"1"}}),""===t&&(i=null),i&&e.nestedField&&(i={nested:{path:e.nestedField,query:i}}),i},F.shouldQuery=function(t,e,s){void 0===s&&(s={searchOperators:!1,queryFormat:"or",fuzziness:0});var i=e.map((function(t){return"object"==typeof t?t.field+(t.weight?"^"+t.weight:""):t}));return s.searchOperators?{query:t,fields:i,default_operator:s.queryFormat}:"and"===s.queryFormat?[{multi_match:{query:t,fields:i,type:"cross_fields",operator:"and"}},{multi_match:{query:t,fields:i,type:"phrase",operator:"and"}}]:[{multi_match:{query:t,fields:i,type:"best_fields",operator:"or",fuzziness:s.fuzziness}},{multi_match:{query:t,fields:i,type:"phrase",operator:"or"}}]},F.highlightQuery=function(t,e,s){if(!t)return null;var r={},n=e||s,o="string"==typeof e?[e]:e;return"string"==typeof n?r[n]={}:Array.isArray(n)&&n.forEach((function(t){"object"==typeof t?r[t.field]={}:r[t]={}})),{highlight:i({pre_tags:["<mark>"],post_tags:["</mark>"],fields:r},o&&{require_field_match:!1})}},F.compositeAggsQuery=function(t,e){var s,i,r;return{aggs:(r={},r[t]={composite:{sources:[(s={},s[t]={terms:{field:t}},s)],size:e},aggs:(i={},i[t]={top_hits:{size:1}},i)},r)}},F.generateQueryOptions=function(t){var e,s={};if(void 0!==t.size&&(s.size=t.size),void 0!==t.from&&(s.from=t.from),t.includeFields||t.excludeFields){var i={};t.includeFields&&(i.includes=t.includeFields),t.excludeFields&&(i.excludes=t.excludeFields),s._source=i}if(t.sortOptions)s.sort=[(e={},e[t.sortOptions[0].dataField]={order:t.sortOptions[0].sortBy},e)];else if(t.sortBy&&t.sortByField){var r;s.sort=[(r={},r[t.sortByField]={order:t.sortBy},r)]}return t.aggregationField&&(s.aggs=F.compositeAggsQuery(t.aggregationField,t.size||0).aggs),s},F}));
//# sourceMappingURL=searchbase.umd.min.js.map
